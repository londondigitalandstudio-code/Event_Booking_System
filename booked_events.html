<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booked Events</title>

<style>
*{
  box-sizing:border-box;
  font-family:"Segoe UI", system-ui, sans-serif;
}

body{
  margin:0;
  background:#f2f4f8;
  padding:15px;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#fff;
  padding:16px 18px;
  border-radius:14px 14px 0 0;
  font-size:15px;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:10px;
}

/* CARD */
.page-card{
  background:#fff;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  overflow:hidden;
}

/* CONTENT */
.content{
  padding:16px;
}

/* LOADING */
#loading{
  font-size:14px;
  color:#777;
  margin:10px 0;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

thead{
  background:#eef2ff;
}

th{
  text-align:left;
  font-size:10px;
  font-weight:600;
  padding:10px;
}

td{
  padding:12px 10px;
  font-size:14px;
  border-bottom:1px solid #eee;
  color:#444;
}

tbody tr:hover{
  background:#f9fafb;
}

/* MOBILE */
@media(max-width:600px){
  th{ font-size:10px; }
  td{ font-size:11px; }
}

/* =========================
   ‚úÖ CLEAN COPY HIGHLIGHT (TEXT ONLY)
========================= */

.event-id {
  cursor: pointer;

 
}

/* When copied */
.event-id.copied {
  color: #16a34a; /* Green */
  font-weight: 500;
 
}





</style>
</head>

<body>

<div class="page-card">

  <!-- HEADER -->
  <div class="header">üìå Booked Events</div>

  <!-- CONTENT -->
  <div class="content">

    <p id="loading">‚è≥ Loading events‚Ä¶</p>

    <table>
      <thead>
        <tr>
          <th>Event Date</th>
          <th>Event ID</th>
          <th>Customer</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

  </div>
</div>


<script>
/* =========================
   üåê GOOGLE SHEET URL
========================= */
const SHEET_URL =
  "https://script.google.com/macros/s/AKfycbwbXAy0GOlepXD3W_6cE6QS8H0cW3nIcSNvbSSpF1f_An6lk4DYlPpaQ33-Q72TxYHg/exec";

/* =========================
   üõ°Ô∏è DATE FORMAT
========================= */
function formatDateSafe(value) {
  if (!value) return "";

  if (typeof value === "number") {
    return formatDate(new Date((value - 25569) * 86400 * 1000));
  }

  const d = new Date(value);
  return isNaN(d.getTime()) ? "" : formatDate(d);
}

function formatDate(d) {
  return `${String(d.getDate()).padStart(2, "0")}-${String(
    d.getMonth() + 1
  ).padStart(2, "0")}-${d.getFullYear()}`;
}

/* =========================
   üìã COPY EVENT ID (MOBILE + DESKTOP FIX)
========================= */

let copiedEl = null;

function copyEventId(id, el) {
  if (!id) return;

  // Reset previous copied
  if (copiedEl && copiedEl !== el) {
    copiedEl.textContent = copiedEl.dataset.original;
    copiedEl.classList.remove("copied");
  }

  if (!el.dataset.original) {
    el.dataset.original = el.textContent;
  }

  // Try modern clipboard first
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(id)
      .then(() => showCopied(el))
      .catch(() => fallbackCopy(id, el));
  } else {
    // Fallback for mobile
    fallbackCopy(id, el);
  }
}

/* =========================
   üì± MOBILE FALLBACK COPY
========================= */

function fallbackCopy(text, el) {
  const input = document.createElement("textarea");

  input.value = text;
  input.style.position = "fixed";
  input.style.opacity = "0";

  document.body.appendChild(input);

  input.focus();
  input.select();

  try {
    document.execCommand("copy");
    showCopied(el);
  } catch (err) {
    alert("‚ùå Copy not supported. Please copy manually.");
  }

  document.body.removeChild(input);
}

/* =========================
   ‚úÖ SHOW COPIED STATUS
========================= */

function showCopied(el) {
  el.textContent = "Copied!";
  el.classList.add("copied");
  copiedEl = el;

  setTimeout(() => {
    if (el.dataset.original) {
      el.textContent = el.dataset.original;
      el.classList.remove("copied");
    }
  }, 1500);
}

/* =========================
   üíæ CACHE
========================= */
const CACHE_KEY = "bookedEvents";

function getCachedEvents() {
  return JSON.parse(localStorage.getItem(CACHE_KEY) || "[]");
}

function saveCachedEvents(data) {
  localStorage.setItem(CACHE_KEY, JSON.stringify(data));
}

/* =========================
   üß± RENDER TABLE
========================= */
function renderEvents(data) {
  const tbody = document.getElementById("tableBody");
  if (!tbody) return;

  tbody.innerHTML = "";

  data.forEach(item => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${formatDateSafe(item.eventDate)}</td>
      <td class="event-id" title="Click to copy"
          onclick="copyEventId('${item.eventId}', this)">
        ${item.eventId || ""}
      </td>
      <td>${item.customerName || ""}</td>
      <td>${item.eventType || ""}</td>
    `;

    tbody.appendChild(tr);
  });
}

/* =========================
   ‚ö° LOAD CACHE INSTANTLY
========================= */
function loadFromCacheInstantly() {
  const cached = getCachedEvents();
  if (cached.length > 0) {
    renderEvents(cached);
    return true;
  }
  return false;
}

/* =========================
   üîÑ GOOGLE SYNC (FAST + SAFE)
========================= */
let retryCount = 0;

async function syncWithGoogle() {
  const loading = document.getElementById("loading");

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 7000);

  try {
    const res = await fetch(
      `${SHEET_URL}?action=getBookedEvents&t=${Date.now()}`,
      { signal: controller.signal }
    );

    const json = await res.json();
    if (json.status !== "success") throw new Error("Invalid response");

    const activeEvents = json.data
      .filter(e => !e.attended)
      .sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));

    const cached = getCachedEvents();

    if (JSON.stringify(cached) !== JSON.stringify(activeEvents)) {
      saveCachedEvents(activeEvents);
      renderEvents(activeEvents);
    }

    retryCount = 0;
    loading.style.display = "none";
  } catch (err) {
    if (err.name !== "AbortError") {
      retryCount++;
      if (retryCount <= 3) {
        setTimeout(syncWithGoogle, 4000);
      } else {
        loading.textContent = "‚ùå Unable to load events";
      }
      console.error(err);
    }
  } finally {
    clearTimeout(timeout);
  }
}

/* =========================
   üöÄ INIT (NO MANUAL REFRESH)
========================= */
function loadBookedEvents() {
  const loading = document.getElementById("loading");

  const hasCache = loadFromCacheInstantly();
  loading.style.display = hasCache ? "none" : "block";

  syncWithGoogle();
}

loadBookedEvents();

/* =========================
   üëÄ TAB ACTIVE REFRESH
========================= */
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) syncWithGoogle();
});

/* =========================
   üîÅ AUTO REFRESH (30s)
========================= */
setInterval(() => {
  if (!document.hidden) syncWithGoogle();
}, 1000);

</script>
</body>
</html>